rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── PRODUCTS ──────────────────────────────────────────
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ─── CATEGORIES ────────────────────────────────────────
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ─── ORDERS ────────────────────────────────────────────
    // Orders are created by Cloud Functions (server-side)
    // Customers can read their own order; admins can read/update all
    match /orders/{orderId} {
      allow create: if isValidOrder();
      allow read: if isAdmin() || isOrderOwner();
      allow update: if isAdmin();
      allow delete: if isAdmin();

      function isOrderOwner() {
        return request.auth != null &&
               resource.data.customer.email == request.auth.token.email;
      }

      function isValidOrder() {
        let data = request.resource.data;
        return data.keys().hasAll(['customer', 'items', 'totalAmount', 'status']) &&
               data.customer is map &&
               data.customer.keys().hasAll(['name', 'email', 'phone']) &&
               data.customer.name is string && data.customer.name.size() >= 2 &&
               data.customer.email is string &&
               data.customer.phone is string &&
               data.items is list && data.items.size() > 0 &&
               data.totalAmount is number && data.totalAmount > 0 &&
               data.status is string;
      }
    }

    // ─── SETTINGS ──────────────────────────────────────────
    match /settings/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ─── CONTACT MESSAGES ────────────────────────────────
    // Public can create (via Cloud Function), only admin reads
    match /contactMessages/{messageId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ─── NEWSLETTER ──────────────────────────────────────
    // Public can create (via Cloud Function), only admin reads
    match /newsletter/{subId} {
      allow create: if true;
      allow read, delete: if isAdmin();
    }

    // ─── ADMIN HELPER ──────────────────────────────────────
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'premamsilks@gmail.com'
             ];
    }
  }
}
